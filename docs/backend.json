{
  "entities": {
    "Module": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Module",
      "type": "object",
      "description": "Represents a module in the tracking system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the module."
        },
        "yard": {
          "type": "string",
          "description": "The yard where the module is located."
        },
        "location": {
          "type": "string",
          "description": "The location within the yard where the module is located."
        },
        "moduleNo": {
          "type": "string",
          "description": "The module number."
        },
        "rfloDate": {
          "type": "string",
          "description": "The RFLO (Ready For Load Out) date.",
          "format": "date-time"
        },
        "shipmentNo": {
          "type": "string",
          "description": "The shipment number associated with the module."
        },
        "rfloDateStatus": {
          "type": "string",
          "description": "The status of the RFLO date confirmation."
        },
        "yardReport": {
          "type": "string",
          "description": "Yard report information for the module."
        },
        "islandReport": {
          "type": "string",
          "description": "Island report information for the module."
        },
        "combinedReport": {
          "type": "string",
          "description": "Combined report information for the module."
        },
        "lastUpdatedBy": {
          "type": "string",
          "description": "The user who last updated the module's information."
        },
        "progressNotes": {
          "type": "string",
          "description": "Notes on the progress of the module, with dates."
        }
      },
      "required": [
        "id",
        "yard",
        "location",
        "moduleNo",
        "rfloDate",
        "shipmentNo",
        "rfloDateStatus"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the ModuleTrack application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "username": {
          "type": "string",
          "description": "The username of the user."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The role of the user (e.g., admin, read-only)."
        }
      },
      "required": [
        "id",
        "username",
        "email",
        "role"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/modules/{moduleId}",
        "definition": {
          "entityName": "Module",
          "schema": {
            "$ref": "#/backend/entities/Module"
          },
          "description": "Stores module data. Includes 'lastUpdatedBy' for authorization independence.",
          "params": [
            {
              "name": "moduleId",
              "description": "Unique identifier for the module."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles, including roles.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Documents in this collection denote admin users. Existence implies admin role.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the ModuleTrack application's core features, including data import, progress tracking, dynamic reporting, data filtering, and user authentication with role-based access control. The primary focus is on ensuring data integrity, security, and scalability while adhering to the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters).\n\n**Structure:**\n\n1.  **/modules/{moduleId}**: This collection stores the module data. Access control is managed using the 'lastUpdatedBy' field and global roles.\n2.  **/users/{userId}**: Stores user profiles, including roles. Roles are managed through this collection instead of custom claims (DBAC).\n3.  **/roles_admin/{userId}**: Documents in this collection denote admin users. Existence of a document implies admin role (DBAC).\n\n**Authorization Independence (Denormalization):**\n\n*   The `modules` collection includes the `lastUpdatedBy` field, which holds the user ID of the user who last updated the module. This denormalization facilitates independent authorization checks in security rules without needing to perform expensive `get()` operations to fetch user information. Security rules can directly check if `request.auth.uid == resource.data.lastUpdatedBy` or check for the user's existence in `/roles_admin/{userId}`.\n\n**QAPs (Rules are not Filters):**\n\n*   The structure supports secure `list` operations by segregating data based on role. Admins can list all modules, while regular users can only list modules they've updated (enforced through security rules checking `lastUpdatedBy`). The `roles_admin` collection enables efficient role-based filtering without exposing sensitive data.\n\n**Other Considerations:**\n\n*   Timestamps for creation and updates are handled within the application logic to ensure consistency.\n*   The structure facilitates straightforward implementation of the application's core features:\n    *   **Data Import**: Modules are added to the `/modules` collection.\n    *   **Progress Tracking**: Module status updates modify fields in the `/modules/{moduleId}` documents.\n    *   **Dynamic Reporting**: Reports are generated by querying and aggregating data from the `/modules` collection, filtered by various criteria.\n    *   **Data Filtering and Search**: Queries on the `/modules` collection, using compound indexes, support filtering based on fields like `yard`, `location`, `moduleNo`, `rfloDate`, `shipmentNo`, and `rfloDateStatus`.\n    *   **User Authentication**: Firebase Authentication handles user sign-in, and user roles (stored in `/users/{userId}`) combined with the presence check in `/roles_admin/{userId}` enforce access control.\n    *   **Anomaly Detection**: The application can implement anomaly detection logic by querying the `/modules` collection and analyzing the data, potentially leveraging the progress notes and RFLO date fields."
  }
}